

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agentlib.core.module &mdash; agentlib 0.8.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />

  
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            agentlib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutorials/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ModulesList.html">List of standard modules and models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../AgentVariable.html">AgentVariables and ModelVariables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../agentlib.html">agentlib package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">agentlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agentlib.core.module</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agentlib.core.module</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains the base AgentModule.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">get_type_hints</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pydantic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">ConfigDict</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">PrivateAttr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic.json_schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">GenerateJsonSchema</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">core_schema</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">agentlib.core.logging_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">agentlib_logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.core.datamodels</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AgentVariable</span><span class="p">,</span>
    <span class="n">Source</span><span class="p">,</span>
    <span class="n">AgentVariables</span><span class="p">,</span>
    <span class="n">AttrsToPydanticAdaptor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.core.environment</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomSimpyEnvironment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.core.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigurationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.utils.fuzzy_matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">fuzzy_match</span><span class="p">,</span> <span class="n">RAPIDFUZZ_IS_INSTALLED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">include_defaults_in_root</span><span class="p">,</span>
    <span class="n">update_default_agent_variable</span><span class="p">,</span>
    <span class="n">is_list_of_agent_variables</span><span class="p">,</span>
    <span class="n">is_valid_agent_var_config</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># this avoids circular import</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">agentlib.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="BaseModuleConfig"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">BaseModuleConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pydantic data model for basic module configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The type is relevant to load the correct module class.</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The type of the Module. Used to find the Python-Object &quot;</span>
        <span class="s2">&quot;from all agentlib-core and plugin Module options. If a dict is given,&quot;</span>
        <span class="s2">&quot;it must contain the keys &#39;file&#39; and &#39;class_name&#39;. &quot;</span>
        <span class="s2">&quot;&#39;file&#39; is the filepath of a python file containing the Module.&quot;</span>
        <span class="s2">&quot;&#39;class_name&#39; is the name of the Module class within this file.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># A module is uniquely identified in the MAS using agent_id and module_id.</span>
    <span class="c1"># The module_id should be unique inside one agent.</span>
    <span class="c1"># This is checked inside the agent-class.</span>
    <span class="n">module_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The unqiue id of the module within an agent, &quot;</span>
        <span class="s2">&quot;used only to communicate withing the agent.&quot;</span>
    <span class="p">)</span>
    <span class="n">validate_incoming_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Validate Incoming Values&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, the validator of the AgentVariable value is called when &quot;</span>
        <span class="s2">&quot;receiving a new value from the DataBroker.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The log level for this Module. &quot;</span>
        <span class="s2">&quot;Default uses the root-loggers level.&quot;</span>
        <span class="s2">&quot;Options: DEBUG; INFO; WARNING; ERROR; CRITICAL&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">shared_variable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of strings with each string being a field of the Modules configs. &quot;</span>
        <span class="s2">&quot;The field must be or contain an AgentVariable. If the field is added to this list, &quot;</span>
        <span class="s2">&quot;all shared attributes of the AgentVariables will be set to True.&quot;</span><span class="p">,</span>
        <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Aggregation of all instances of an AgentVariable in this Config</span>
    <span class="n">_variables</span><span class="p">:</span> <span class="n">AgentVariables</span> <span class="o">=</span> <span class="n">PrivateAttr</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>

    <span class="c1"># The config given by the user to instantiate this class.</span>
    <span class="c1"># Will be stored to enable a valid overwriting of the</span>
    <span class="c1"># default config and to better restart modules.</span>
    <span class="c1"># Is also useful to debug validators and the general BaseModuleConfig.</span>
    <span class="n">_user_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">PrivateAttr</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate_assignment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">,</span>
        <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="BaseModuleConfig.get_variables"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.get_variables">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the private attribute with all AgentVariables&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span></div>

<div class="viewcode-block" id="BaseModuleConfig.model_json_schema"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.model_json_schema">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_json_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Custom schema method to</span>
<span class="sd">        - Add JSON Schema for custom attrs types Source and AgentVariable</span>
<span class="sd">        - put log_level last, as it is the only optional field of the module config.</span>
<span class="sd">        Used to better display relevant options of children classes in GUIs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;schema_generator&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Custom schema_generator is not supported for BaseModule.&quot;</span><span class="p">)</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">CustomGenerateJsonSchema</span><span class="p">(</span><span class="n">GenerateJsonSchema</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This class in necessary, as the default object type</span>
<span class="sd">            AttrsToPydanticAdaptor (e.g. Source, AgentVariable) are</span>
<span class="sd">            not json serializable by default.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">default_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">core_schema</span><span class="o">.</span><span class="n">WithDefaultSchema</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                    <span class="n">_default</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_default</span><span class="p">,</span> <span class="n">AttrsToPydanticAdaptor</span><span class="p">):</span>
                        <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_default</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default_schema</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;schema_generator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomGenerateJsonSchema</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;$defs&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">definitions_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">definitions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">ATTRS_MODELS</span><span class="p">:</span>
                <span class="n">class_object</span><span class="p">:</span> <span class="n">AttrsToPydanticAdaptor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">datamodels</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">class_object</span><span class="o">.</span><span class="n">get_json_schema</span><span class="p">()</span>
            <span class="n">definitions_out</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">if</span> <span class="n">definitions_out</span><span class="p">:</span>
            <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;$defs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">definitions_out</span>

        <span class="n">log_level</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;log_level&quot;</span><span class="p">)</span>
        <span class="n">shared_variable_fields</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;shared_variable_fields&quot;</span><span class="p">)</span>
        <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;shared_variable_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared_variable_fields</span>
        <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="k">return</span> <span class="n">schema</span></div>

<div class="viewcode-block" id="BaseModuleConfig.check_if_variables_are_unique"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.check_if_variables_are_unique">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_variables_are_unique</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a given iterable of AgentVariables have a</span>
<span class="sd">        unique name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> contains variables with the same name. The &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;following appear at least twice: </span><span class="si">{</span><span class="s1">&#39; ,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BaseModuleConfig.check_valid_fields"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.check_valid_fields">[docs]</a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;shared_variable_fields&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_valid_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shared_variables_fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the shared_variables_fields are valid</span>
<span class="sd">        fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrong_public_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">shared_variables_fields</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">wrong_public_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Public fields </span><span class="si">{</span><span class="n">wrong_public_fields</span><span class="si">}</span><span class="s2"> do not exist. Maybe you &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;misspelled them?&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">shared_variables_fields</span></div>

<div class="viewcode-block" id="BaseModuleConfig.check_valid_level"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.check_valid_level">[docs]</a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;log_level&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_valid_level</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the given log_level is valid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log_level</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">log_level</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Given log level &#39;</span><span class="si">{</span><span class="n">log_level</span><span class="si">}</span><span class="s2">&#39; is not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;supported by logging library.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">log_level</span></div>

<div class="viewcode-block" id="BaseModuleConfig.merge_variables"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.merge_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_variables</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pre_validated_instance</span><span class="p">:</span> <span class="n">BaseModuleConfig</span><span class="p">,</span>
        <span class="n">user_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">shared_variable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge, rigorously check and validate the input of</span>
<span class="sd">        all AgentVariables into the module.</span>
<span class="sd">        This function:</span>

<span class="sd">        - Collects all variables</span>
<span class="sd">        - Checks if duplicate names (will cause errors in the get() function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Extract all variables from fields</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># If field is missing in values, validation of field was not</span>
            <span class="c1"># successful. Continue and pydantic will later raise the ValidationError</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pre_validated_instance</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">pre_merged_attr</span> <span class="o">=</span> <span class="n">pre_validated_instance</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="c1"># we need the type if plugins subclass the AgentVariable</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pre_merged_attr</span><span class="p">,</span> <span class="n">AgentVariable</span><span class="p">):</span>
                <span class="n">update_var_with</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">{})</span>

                <span class="n">make_shared</span> <span class="o">=</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">shared_variable_fields</span>

                <span class="n">var</span> <span class="o">=</span> <span class="n">update_default_agent_variable</span><span class="p">(</span>
                    <span class="n">default_var</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                    <span class="n">user_data</span><span class="o">=</span><span class="n">update_var_with</span><span class="p">,</span>
                    <span class="n">make_shared</span><span class="o">=</span><span class="n">make_shared</span><span class="p">,</span>
                    <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
                    <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="n">pre_validated_instance</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">is_list_of_agent_variables</span><span class="p">(</span><span class="n">pre_merged_attr</span><span class="p">):</span>
                <span class="n">user_config_var_dicts</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="n">pre_merged_attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="n">update_vars_with</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">conf</span>
                    <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">user_config_var_dicts</span>
                    <span class="k">if</span> <span class="n">is_valid_agent_var_config</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="n">make_shared</span> <span class="o">=</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">shared_variable_fields</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="n">include_defaults_in_root</span><span class="p">(</span>
                    <span class="n">variables</span><span class="o">=</span><span class="n">update_vars_with</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                    <span class="n">type_</span><span class="o">=</span><span class="n">type_</span><span class="p">,</span>  <span class="c1"># subtype of AgentVariable</span>
                    <span class="n">make_shared</span><span class="o">=</span><span class="n">make_shared</span><span class="p">,</span>
                    <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
                    <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">_vars</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
                <span class="n">pre_validated_instance</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>

        <span class="c1"># Extract names</span>
        <span class="n">variable_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_vars</span><span class="p">]</span>

        <span class="c1"># First check if names exists more than once</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">check_if_variables_are_unique</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">variable_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_var</span> <span class="ow">in</span> <span class="n">_vars</span><span class="p">:</span>
            <span class="c1"># case the agent id is a different agent</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_var</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">!=</span> <span class="n">agent_id</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">_var</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">module_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Setting given module_id &#39;</span><span class="si">%s</span><span class="s2">&#39; in variable &#39;</span><span class="si">%s</span><span class="s2">&#39; to None. &quot;</span>
                    <span class="s2">&quot;You can not specify module_ids of other agents.&quot;</span><span class="p">,</span>
                    <span class="n">_var</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">module_id</span><span class="p">,</span>
                    <span class="n">_var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_var</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">agent_id</span><span class="o">=</span><span class="n">_var</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_vars</span></div>

<div class="viewcode-block" id="BaseModuleConfig.default"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModuleConfig.default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_agent_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_user_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">better_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improve_extra_field_error_messages</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">better_error</span>
        <span class="c1"># Enable mutation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="s2">&quot;frozen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">merge_variables</span><span class="p">(</span>
            <span class="n">pre_validated_instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">user_config</span><span class="o">=</span><span class="n">_user_config</span><span class="p">,</span>
            <span class="n">agent_id</span><span class="o">=</span><span class="n">_agent_id</span><span class="p">,</span>
            <span class="n">shared_variable_fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_variable_fields</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_config</span> <span class="o">=</span> <span class="n">_user_config</span>
        <span class="c1"># Disable mutation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="s2">&quot;frozen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_improve_extra_field_error_messages</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">ValidationError</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks the validation errors for invalid fields and adds suggestions for</span>
<span class="sd">        correct field names to the error message.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">RAPIDFUZZ_IS_INSTALLED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

        <span class="n">error_list</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;extra_forbidden&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># change error type to literal because it allows for context</span>
            <span class="n">error</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;literal_error&quot;</span>
            <span class="c1"># pydantic automatically prints the __dict__ of an error, so it is</span>
            <span class="c1"># sufficient to just assign the suggestions to an arbitrary attribute of</span>
            <span class="c1"># the error</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">fuzzy_match</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">error</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">choices</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">error</span><span class="p">[</span><span class="s2">&quot;ctx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;a valid Field name. Field &#39;</span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; does &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;not exist. Did you mean any of </span><span class="si">{</span><span class="n">suggestions</span><span class="si">}</span><span class="s2">?&quot;</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">ValidationError</span><span class="o">.</span><span class="n">from_exception_data</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">line_errors</span><span class="o">=</span><span class="n">error_list</span>
        <span class="p">)</span></div>


<span class="n">BaseModuleConfigClass</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;BaseModuleConfigClass&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">BaseModuleConfig</span><span class="p">)</span>


<div class="viewcode-block" id="BaseModule"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">BaseModule</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic module used by any agent.</span>
<span class="sd">    Besides a common configuration, where ids</span>
<span class="sd">    and variables are defined, this class manages</span>
<span class="sd">    the setting and getting of variables and relevant</span>
<span class="sd">    attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-public-methods</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">agentlib_logging</span><span class="o">.</span><span class="n">create_logger</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>  <span class="c1"># evokes the config setter</span>
        <span class="c1"># Add process to environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_callbacks</span><span class="p">()</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># Methods to inherit by subclasses</span>
    <span class="c1">############################################################################</span>

<div class="viewcode-block" id="BaseModule.get_config_type"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.get_config_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_config_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModuleConfigClass</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;config_type&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;config_type&#39; attribute is deprecated and has been removed. &quot;</span>
                <span class="s2">&quot;Please use the following syntax to assign the config of your custom &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;module &#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;class MyModule(agentlib.BaseModule):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    config: MyConfigClass</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModule.register_callbacks"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.register_callbacks">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Needs to be implemented by derived modules&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModule.process"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.process">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This abstract method must be implemented in order to sync the module</span>
<span class="sd">        with the other processes of the agent and the whole MAS.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Needs to be implemented by derived modules&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModule.terminate"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.terminate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate all relevant processes of the module.</span>
<span class="sd">        This is necessary to correctly terminate an agent</span>
<span class="sd">        at runtime. Not all modules may need this, hence it is</span>
<span class="sd">        not an abstract method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Successfully terminated module </span><span class="si">%s</span><span class="s2"> in agent </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1"># Properties</span>
    <span class="c1">############################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Agent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the agent this module is located in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseModuleConfigClass</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The module config.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BaseModuleConfigClass: Config of type self.config_type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>

    <span class="nd">@config</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseModuleConfig</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a new config&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_type</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;The module has no valid config. Please make sure you &quot;</span>
                <span class="s2">&quot;specify the class attribute &#39;config&#39; when writing your module.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_type</span><span class="p">()(</span><span class="n">_agent_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Update variables:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentVariable</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_list_to_dict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_variables</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Now de-and re-register all callbacks:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_variable_callbacks</span><span class="p">()</span>

        <span class="c1"># Set log-level</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
                <span class="n">_root_lvl_int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">level</span>
                <span class="n">_log_lvl_int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_log_lvl_int</span> <span class="o">&lt;</span> <span class="n">_root_lvl_int</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Log level &#39;</span><span class="si">%s</span><span class="s2">&#39; is below root loggers level &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
                        <span class="s2">&quot;Without calling logging.basicConfig, &quot;</span>
                        <span class="s2">&quot;logs will not be printed.&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">_root_lvl_int</span><span class="p">),</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># Call the after config update:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_config_update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_after_config_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called after the config of</span>
<span class="sd">        the module is updated.</span>

<span class="sd">        Overwrite this function to enable custom behaviour</span>
<span class="sd">        after your config is updated.</span>
<span class="sd">        For instance, a simulator may re-initialize it&#39;s model,</span>
<span class="sd">        or a coordinator in an ADMM-MAS send new settings to</span>
<span class="sd">        the participants.</span>

<span class="sd">        Returns nothing, the config is immutable</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_register_variable_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This functions de-registers and then re-registers</span>
<span class="sd">        callbacks for all variables of the module to</span>
<span class="sd">        update their specific values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Keep everything in THAT order!!</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">data_broker</span><span class="o">.</span><span class="n">deregister_callback</span><span class="p">(</span>
                <span class="n">alias</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_config_vars</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">data_broker</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span>
                <span class="n">alias</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_config_vars</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">_unsafe_no_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CustomSimpyEnvironment</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the environment of the agent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the module&#39;s id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">module_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Source</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the source of the module,</span>
<span class="sd">        containing the agent and module id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Source</span><span class="p">(</span><span class="n">agent_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">module_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentVariable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all values as a list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># Get, set and updaters</span>
    <span class="c1">############################################################################</span>
<div class="viewcode-block" id="BaseModule.get"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.get">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentVariable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get any variable matching the given name:</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The item to get by name of Variable.</span>
<span class="sd">                        Hence, item=AgentVariable.name</span>
<span class="sd">        Returns:</span>
<span class="sd">            var (AgentVariable): The matching variable</span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the item was not found in the variables of the</span>
<span class="sd">                      module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;no AgentVariable with the name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the configs variables.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span></div>

<div class="viewcode-block" id="BaseModule.get_value"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.get_value">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value of the variable matching the given name:</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The item to get by name of Variable.</span>
<span class="sd">                        Hence, item=AgentVariable.name</span>
<span class="sd">        Returns:</span>
<span class="sd">            var (Any): The matching value</span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the item was not found in the variables of the</span>
<span class="sd">                      module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;no AgentVariable with the name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the configs variables.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span></div>

<div class="viewcode-block" id="BaseModule.set"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.set">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set any variable by using the name:</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The item to get by name of Variable.</span>
<span class="sd">                        Hence, item=AgentVariable.name</span>
<span class="sd">            value (Any): Any value to set to the Variable</span>
<span class="sd">            timestamp (float): The timestamp associated with the variable.</span>
<span class="sd">                If None, current environment time is used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If the item was not found in the variables of the</span>
<span class="sd">                            module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># var = self.get(name)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_relevant_values</span><span class="p">(</span>
            <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">data_broker</span><span class="o">.</span><span class="n">send_variable</span><span class="p">(</span>
            <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">}),</span>
            <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BaseModule.update_variables"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.update_variables">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentVariable</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the given list of variables in the current data_broker.</span>
<span class="sd">        If a given Variable is not in the config of the module, an</span>
<span class="sd">        error is raised.</span>
<span class="sd">        TODO: check if this is needed, we currently don&#39;t use it anywhere</span>

<span class="sd">        Args:</span>
<span class="sd">            variables: List with agent_variables.</span>
<span class="sd">            timestamp: The timestamp associated with the variable.</span>
<span class="sd">                If None, current environment time is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;no AgentVariable with the name &#39;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;in the config.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1"># Private and or static class methods</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_relevant_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the given variables fields</span>
<span class="sd">        with the given value (and possibly timestamp)</span>
<span class="sd">        Args:</span>
<span class="sd">            variable (AgentVariable): The variable to be updated.</span>
<span class="sd">            value (Any): Any value to set to the Variable</span>
<span class="sd">            timestamp (float): The timestamp associated with the variable.</span>
<span class="sd">                If None, current environment time is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AgentVariable: The updated variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update value</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Update timestamp</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="c1"># Return updated variable</span>
        <span class="k">return</span> <span class="n">variable</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_callback_config_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback to update the AgentVariables of the module defined in the</span>
<span class="sd">        config.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable: Variable sent by data broker</span>
<span class="sd">            name: Name of the variable in own config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">own_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">own_var</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate_incoming_values</span><span class="p">)</span>
        <span class="n">own_var</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">timestamp</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_list_to_dict</span><span class="p">(</span><span class="n">ls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentVariable</span><span class="p">]):</span>
        <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ls</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>

<div class="viewcode-block" id="BaseModule.get_results"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.get_results">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns results of this modules run.</span>

<span class="sd">        Override this method, if your module creates data that you would like to obtain</span>
<span class="sd">         after the run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Some form of results data, often in the form of a pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseModule.cleanup_results"><a class="viewcode-back" href="../../../code/agentlib.core.html#agentlib.BaseModule.cleanup_results">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all files this module created.</span>

<span class="sd">        Override this method, if your module creates e.g. results files etc.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, AGENT-Project Associates.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>